name: Pre Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Build
        run: ./gradlew build

      - name: Get base version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "base=$TAG" >> $GITHUB_OUTPUT

      - name: Count existing pre-releases
        id: count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE=${{ steps.version.outputs.base }}

          COUNT=$(gh release list \
            --limit 100 \
            --json tagName \
            --jq "[.[] | select(.tagName | startswith(\"$BASE-pre-\"))] | length")

          echo "num=$((COUNT + 1))" >> $GITHUB_OUTPUT

      - name: Create pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE=${{ steps.version.outputs.base }}
          NUM=${{ steps.count.outputs.num }}

          gh release create \
            "$BASE-pre-$NUM" \
            build/libs/*.jar \
            --title "$BASE pre $NUM" \
            --notes "Pre-release $BASE-pre-$NUM" \
            --prerelease
